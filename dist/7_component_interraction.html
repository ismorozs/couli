<!DOCTYPE html>
<html>
<head>
  <title></title>
  <style type="text/css">
    div {
      border: 2px solid black;
    }
    span {
      background-color: white;
    }
  </style>
</head>
<body>
  <script type="text/javascript" src="couli.js"></script>

  <script type="text/javascript">
    window.COLORS = ['white', 'red', 'green', 'blue', 'orange', 'grey', 'yellow', 'violet', 'teal', 'purple', 'pink'];

    const styleStr = window.COLORS.reduce((a, v) => `${a} .${v} {background-color: ${v} }\n`, '');

    const styleEl = document.createElement('style');
    styleEl.appendChild( document.createTextNode(styleStr) );
    document.head.appendChild(styleEl);

    function evaluateClass (item) {
      return window.COLORS.reduce((a, v) => {
        a[v] = v === item.color
        return a;
      }, {})
    }
  </script>

  <script type="text/javascript">
    Couli.define('select', `
      <select x-lb='options'>
        <option x-b="option">
      </select>
    `, {
      options: { events: { change: (e, el, ci) => { ci.up().set({ choosen: e.target.value }) } } }
    });

    Couli.define('text', `
      <span x-b='text'></span>
    `, {}, {
      '': {
        position: 'absolute',
        top: 0,
        right: 0
      }
    });

    Couli.define('select-color', `
        <select options=colors>
    `, {
      colors: {},
      choosen: { hooks: { update: (e, val, ci) => { ci.up().set({ choosenColor: val }) } } },
      '': { hooks: { mount: (el, vals, ci) => ci.set({ choosen: 'white', colors: window.COLORS.map((el) => ({ option: el })) }) } }
    });

    Couli.define('select-child-color', `
      <select-color>
    `, {
      choosenColor: { hooks: { update: (el, val, ci) => { ci.up().set({ childColor: val }) } } }
    });

    Couli.define('select-target', `
      <select options=targets>
    `, {
      targets: {},
      choosen: { hooks: { update: (e, val, ci) => { ci.up().set({ target: val }) } } },
      '': { hooks: { mount: (el, vals, ci) => ci.set({ choosen: '', targets: [{ option: ''}, { option: 'bigSquare'}, { option: 'middleSquare'}, { option: 'smallSquare'}] }) } },
    });

    Couli.define('small-square', `
      <div>
        <text x-state-name="orderedNumber"></text>
        <span>Set color </span><select-color></select-color>
        <span>for </span> <select-target></select-target>
      </div>
    `, {
      '': {
        class: evaluateClass,
        hooks: { mount: (el, vals, ci) => ci.set({ orderedNumber: { text: '№4' } }) }
      },
      color: {},
      choosenColor: { hooks: { update: (el, val, ci) => ci.up( ci.get('target') ).set({ color: val }) } },
      target: { hooks: { update: (el, val, ci) => ci.up(val).set({ color: ci.get('choosenColor') }) } },
    }, {
      '':  {
        width: 300,
        height: 300,
        position: 'relative',
      }
    });

    Couli.define('middle-square', `
      <div>
        <span>Child color: </span><select-child-color></select-child-color>
        <text x-state-name="orderedNumber"></text>
        <small-square color='childColor'  x-state-name="smallSquare">
      </div>
    `, {
      color: {},
      childColor: {},
      '': {
        class: evaluateClass,
        hooks: { mount: (el, vals, ci) => ci.set({ orderedNumber: { text: '№3' } }) }
      }
    }, {
      '': {
        width: 450,
        height: 450,
        position: 'relative',
      }
    });

    Couli.define('big-square', `
      <div>
        <span>Child color: </span><select-child-color></select-child-color>
        <text x-state-name="orderedNumber"></text>
        <middle-square color='childColor'  x-state-name="middleSquare">
      </div>
    `, {
      color: {},
      childColor: {},
      '': {
        class: evaluateClass,
        hooks: { mount: (el, vals, ci) => ci.set({ orderedNumber: { text: '№2' } }) }
      }
    }, {
      '': {
        width: 600,
        height: 600,
        position: 'relative',
      }
    });

    Couli.define('app', `
      <div>
        <span>Child color: </span><select-child-color></select-child-color>
        <text x-state-name="orderedNumber"></text>
        <big-square color='childColor' x-state-name="bigSquare">
      </div>
    `, {
      childColor: {},
      color: {},
      '': {
        class: evaluateClass,
        hooks: { mount: (el, vals, ci) => ci.set({ orderedNumber: { text: '№1' } }) }
      }
    }, {
      '': {
        position: 'relative'
      },
      number: {
        position: 'absolute',
        top: 0,
        right: 0,
        backgroundColor: 'white'
      }
    })

  </script>

  <div id="app">
    <app>
  </div>

  <script type="text/javascript">
    Couli.apply('#app')
  </script>
</body>
</html>
